version: 2
jobs:
  build:
    docker:
      - image: curvetomorrow/auslan-dev-image:v7.8
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    working_directory: /var/www/booking-system-frontend
    parallelism: 6
    steps:
      - checkout
      - setup_remote_docker
      - add_ssh_keys:
          fingerprints:
            - "4f:b6:43:43:0c:10:10:50:3d:30:ce:36:b1:b3:f9:d8"
            - "3a:1b:f4:57:85:e7:ce:3e:85:63:4c:b2:6b:6b:ca:eb"
            - "9f:a5:4b:07:3c:a0:38:17:90:93:4b:5a:52:8e:55:94"
      - run:
          type: shell
          name: Setup parallelism
          command: |
            circleci tests glob "/var/www/booking-system-frontend/e2e-tests/features/*.feature" | circleci tests split > /var/www/booking-system-frontend/test_features_for_split_container.txt
            cat /var/www/booking-system-frontend/test_features_for_split_container.txt
      - run:
          name: Setup the server and run E2E tests
          environment:
            E2E_ENV: "localhost"
          shell: /bin/bash -l
          command: |
            npm install
            npm install codeclimate-test-reporter -g
            ./setup_ci.sh
            ./run-e2e-test.sh
      - run:
          name: Running the unit tests
          environment:
            E2E_ENV: "localhost"
          shell: /bin/bash -l
          command: |
            ./run-unit-test.sh
      - store_test_results:
          path: /var/www/booking-system-frontend/.tmp/cucumber
      - store_artifacts:
          path: /var/www/booking-system-api/rails_server.log
      - store_artifacts:
          path: /var/www/booking-system-frontend/.tmp/