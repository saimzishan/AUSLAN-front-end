machine:
  node:
    version: 7.0.0

test:
  pre:
    - rm -rf tmp
    - bundle exec pact-mock-service start -p 1233 -l tmp/pact-booking.log --pact-dir tmp/pacts
    - bundle exec pact-mock-service start -p 1234 -l tmp/pact-user.log --pact-dir tmp/pacts
    - npm install codeclimate-test-reporter -g
  override:
    - ng lint
    - ng test --code-coverage --watch=false --singleRun=true --browser Chrome_without_security
  post:
    - bundle exec pact-mock-service stop -p 1233
    - bundle exec pact-mock-service stop -p 1234
    - mkdir $CIRCLE_ARTIFACTS/coverage
    - mv coverage/* $CIRCLE_ARTIFACTS/coverage
    - npm run pact
    - cp -rf tmp/ $CIRCLE_ARTIFACTS/
    - codeclimate-test-reporter < $CIRCLE_ARTIFACTS/coverage/coverage.lcov
    - rm -rf dist
    - ng build --aot --env=stage

deployment:
    commands:
      - aws s3 sync dist/  s3://auslan-booking-system-ct/ --delete